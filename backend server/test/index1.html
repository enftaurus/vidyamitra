<!DOCTYPE html>
<html>
<head>
    <title>AI Interview Streaming Test</title>
    <style>
        body {
            font-family: Arial;
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 80px;
        }

        #ai-output {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #ccc;
            min-height: 60px;
            font-size: 18px;
            font-weight: bold;
        }

        button {
            margin-top: 10px;
            padding: 8px 12px;
        }
    </style>
</head>
<body>

<h2>ðŸ”¥ AI Interview Streaming Test</h2>

<h4>Candidate Profile</h4>
<textarea id="profile">Backend developer skilled in Python and DSA</textarea>
<button onclick="startInterview()">Start Interview</button>

<hr>

<h4>AI Interviewer (Streaming Output)</h4>
<div id="ai-output"></div>

<h4>Your Answer</h4>
<textarea id="answer"></textarea>
<button onclick="sendAnswer()">Submit Answer</button>

<script>

let interviewState = null;

async function startInterview() {

    const profile = document.getElementById("profile").value;

    const response = await fetch("http://localhost:8000/interview/start", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ candidate_profile: profile })
    });

    interviewState = await response.json();

    document.getElementById("ai-output").innerText =
        interviewState.current_question;
}

async function sendAnswer() {

    const answer = document.getElementById("answer").value;
    if (!answer.trim()) return;

    // Clear previous AI output
    document.getElementById("ai-output").innerText = "";

    const response = await fetch("http://localhost:8000/interview/continue", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            state: interviewState,
            user_answer: answer
        })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value);

        const lines = buffer.split("\n");
        buffer = lines.pop();

        for (const line of lines) {
            if (!line.trim()) continue;

            const data = JSON.parse(line);

            // ðŸ”¥ ONLY STREAM AI QUESTION TEXT
            if (data.type === "question_chunk") {
                document.getElementById("ai-output").innerText += data.content;
            }

            if (data.type === "done") {
                interviewState = data.state;
            }
        }
    }
}

</script>

</body>
</html>